import{i as g,A}from"./D-zHGvuz.js";import{a8 as x,aZ as L,a7 as J,a9 as p}from"./BHJITWWH.js";/*! js-cookie v3.0.5 | MIT */function I(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)s[r]=t[r]}return s}var N={read:function(s){return s[0]==='"'&&(s=s.slice(1,-1)),s.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(s){return encodeURIComponent(s).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function R(s,e){function t(n,i,o){if(!(typeof document>"u")){o=I({},e,o),typeof o.expires=="number"&&(o.expires=new Date(Date.now()+o.expires*864e5)),o.expires&&(o.expires=o.expires.toUTCString()),n=encodeURIComponent(n).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var u="";for(var d in o)o[d]&&(u+="; "+d,o[d]!==!0&&(u+="="+o[d].split(";")[0]));return document.cookie=n+"="+s.write(i,n)+u}}function r(n){if(!(typeof document>"u"||arguments.length&&!n)){for(var i=document.cookie?document.cookie.split("; "):[],o={},u=0;u<i.length;u++){var d=i[u].split("="),l=d.slice(1).join("=");try{var c=decodeURIComponent(d[0]);if(o[c]=s.read(l,c),n===c)break}catch{}}return n?o[n]:o}}return Object.create({set:t,get:r,remove:function(n,i){t(n,"",I({},i,{expires:-1}))},withAttributes:function(n){return R(this.converter,I({},this.attributes,n))},withConverter:function(n){return R(I({},this.converter,n),this.attributes)}},{attributes:{value:Object.freeze(e)},converter:{value:Object.freeze(s)}})}var w=R(N,{path:"/"});new TextEncoder;const W=new TextDecoder,C=s=>{const e=atob(s),t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t},D=s=>{let e=s;e instanceof Uint8Array&&(e=W.decode(e)),e=e.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return C(e)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}};class a extends Error{constructor(e,t){var r;super(e,t),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,(r=Error.captureStackTrace)==null||r.call(Error,this,this.constructor)}}a.code="ERR_JOSE_GENERIC";class k extends a{constructor(e,t,r="unspecified",n="unspecified"){super(e,{cause:{claim:r,reason:n,payload:t}}),this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=r,this.reason=n,this.payload=t}}k.code="ERR_JWT_CLAIM_VALIDATION_FAILED";class K extends a{constructor(e,t,r="unspecified",n="unspecified"){super(e,{cause:{claim:r,reason:n,payload:t}}),this.code="ERR_JWT_EXPIRED",this.claim=r,this.reason=n,this.payload=t}}K.code="ERR_JWT_EXPIRED";class U extends a{constructor(){super(...arguments),this.code="ERR_JOSE_ALG_NOT_ALLOWED"}}U.code="ERR_JOSE_ALG_NOT_ALLOWED";class b extends a{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}}b.code="ERR_JOSE_NOT_SUPPORTED";class F extends a{constructor(e="decryption operation failed",t){super(e,t),this.code="ERR_JWE_DECRYPTION_FAILED"}}F.code="ERR_JWE_DECRYPTION_FAILED";class V extends a{constructor(){super(...arguments),this.code="ERR_JWE_INVALID"}}V.code="ERR_JWE_INVALID";class q extends a{constructor(){super(...arguments),this.code="ERR_JWS_INVALID"}}q.code="ERR_JWS_INVALID";class f extends a{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}}f.code="ERR_JWT_INVALID";class M extends a{constructor(){super(...arguments),this.code="ERR_JWK_INVALID"}}M.code="ERR_JWK_INVALID";class j extends a{constructor(){super(...arguments),this.code="ERR_JWKS_INVALID"}}j.code="ERR_JWKS_INVALID";class P extends a{constructor(e="no applicable key found in the JSON Web Key Set",t){super(e,t),this.code="ERR_JWKS_NO_MATCHING_KEY"}}P.code="ERR_JWKS_NO_MATCHING_KEY";class G extends a{constructor(e="multiple matching keys found in the JSON Web Key Set",t){super(e,t),this.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS"}}G.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";class $ extends a{constructor(e="request timed out",t){super(e,t),this.code="ERR_JWKS_TIMEOUT"}}$.code="ERR_JWKS_TIMEOUT";class B extends a{constructor(e="signature verification failed",t){super(e,t),this.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED"}}B.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";function Y(s){return typeof s=="object"&&s!==null}function z(s){if(!Y(s)||Object.prototype.toString.call(s)!=="[object Object]")return!1;if(Object.getPrototypeOf(s)===null)return!0;let e=s;for(;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(s)===e}const H=D;function Q(s){if(typeof s!="string")throw new f("JWTs must use Compact JWS serialization, JWT must be a string");const{1:e,length:t}=s.split(".");if(t===5)throw new f("Only JWTs using Compact JWS serialization can be decoded");if(t!==3)throw new f("Invalid JWT");if(!e)throw new f("JWTs must contain a payload");let r;try{r=H(e)}catch{throw new f("Failed to base64url decode the payload")}let n;try{n=JSON.parse(W.decode(r))}catch{throw new f("Failed to parse the decoded payload as JSON")}if(!z(n))throw new f("Invalid JWT Claims Set");return n}const X=new Error("request for lock canceled");var Z=function(s,e,t,r){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function u(c){try{l(r.next(c))}catch(_){o(_)}}function d(c){try{l(r.throw(c))}catch(_){o(_)}}function l(c){c.done?i(c.value):n(c.value).then(u,d)}l((r=r.apply(s,e||[])).next())})};class ee{constructor(e,t=X){this._value=e,this._cancelError=t,this._queue=[],this._weightedWaiters=[]}acquire(e=1,t=0){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise((r,n)=>{const i={resolve:r,reject:n,weight:e,priority:t},o=m(this._queue,u=>t<=u.priority);o===-1&&e<=this._value?this._dispatchItem(i):this._queue.splice(o+1,0,i)})}runExclusive(e){return Z(this,arguments,void 0,function*(t,r=1,n=0){const[i,o]=yield this.acquire(r,n);try{return yield t(i)}finally{o()}})}waitForUnlock(e=1,t=0){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return this._couldLockImmediately(e,t)?Promise.resolve():new Promise(r=>{this._weightedWaiters[e-1]||(this._weightedWaiters[e-1]=[]),te(this._weightedWaiters[e-1],{resolve:r,priority:t})})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(e){this._value=e,this._dispatchQueue()}release(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);this._value+=e,this._dispatchQueue()}cancel(){this._queue.forEach(e=>e.reject(this._cancelError)),this._queue=[]}_dispatchQueue(){for(this._drainUnlockWaiters();this._queue.length>0&&this._queue[0].weight<=this._value;)this._dispatchItem(this._queue.shift()),this._drainUnlockWaiters()}_dispatchItem(e){const t=this._value;this._value-=e.weight,e.resolve([t,this._newReleaser(e.weight)])}_newReleaser(e){let t=!1;return()=>{t||(t=!0,this.release(e))}}_drainUnlockWaiters(){if(this._queue.length===0)for(let e=this._value;e>0;e--){const t=this._weightedWaiters[e-1];t&&(t.forEach(r=>r.resolve()),this._weightedWaiters[e-1]=[])}else{const e=this._queue[0].priority;for(let t=this._value;t>0;t--){const r=this._weightedWaiters[t-1];if(!r)continue;const n=r.findIndex(i=>i.priority<=e);(n===-1?r:r.splice(0,n)).forEach(i=>i.resolve())}}}_couldLockImmediately(e,t){return(this._queue.length===0||this._queue[0].priority<t)&&e<=this._value}}function te(s,e){const t=m(s,r=>e.priority<=r.priority);s.splice(t+1,0,e)}function m(s,e){for(let t=s.length-1;t>=0;t--)if(e(s[t]))return t;return-1}var se=function(s,e,t,r){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function u(c){try{l(r.next(c))}catch(_){o(_)}}function d(c){try{l(r.throw(c))}catch(_){o(_)}}function l(c){c.done?i(c.value):n(c.value).then(u,d)}l((r=r.apply(s,e||[])).next())})};class re{constructor(e){this._semaphore=new ee(1,e)}acquire(){return se(this,arguments,void 0,function*(e=0){const[,t]=yield this._semaphore.acquire(1,e);return t})}runExclusive(e,t=0){return this._semaphore.runExclusive(()=>e(),1,t)}isLocked(){return this._semaphore.isLocked()}waitForUnlock(e=0){return this._semaphore.waitForUnlock(1,e)}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}const E=J(),_e=x(E),h=J(),v=L(h,s=>{if(s!==void 0)return Q(s)}),ne=new re,T=async s=>await ne.runExclusive(async()=>{if(s===void 0){E.set(void 0);return}const e=p(E),t=p(v);(t==null?void 0:t.user_id)!==(e==null?void 0:e.id)&&await oe()});h.subscribe(T);async function oe(){const s=p(v);if(s===void 0){E.set(void 0);return}const e=await de(),t=s.user_id,n=(await g.get(`/users/info/${t}`,e)).data;return E.set(n),n}async function fe(){const s=await O();return await T(s),p(E)}const y="JWTRefreshToken",ie=30,S={sameSite:"strict",secure:!0};function ce(){const s=p(v);if(s===void 0)return!1;const e=s.exp-60;return Date.now()<e*1e3}function pe({access:s,refresh:e},t){const r={...S};t&&(r.expires=ie),w.set(y,e,r),h.set(s)}function Ee(){w.remove(y,S),h.set(void 0)}async function ae(){return ce()?!0:(await ue(),p(h)!==void 0)}async function ue(){var e;const s=w.get(y);if(s===void 0){h.set(void 0);return}try{const t=await g.post("/token/refresh/",{refresh:s});h.set(t.data.access)}catch(t){if(!(t instanceof A))throw t;if(((e=t.response)==null?void 0:e.status)===401){h.set(void 0);return}throw t}}async function O(){return await ae()?p(h):void 0}async function de(){const s=await O();return s===void 0?{}:{headers:{Authorization:`Bearer ${s}`}}}export{fe as a,de as b,h as c,Ee as d,O as g,pe as h,ae as i,ue as r,_e as u};
